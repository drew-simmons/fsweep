name: release

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: update changelog and create release
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: setup uv
        uses: astral-sh/setup-uv@v7

      - name: resolve release tag
        id: version
        run: |
          # Calculate the next version using git-cliff
          next_version=$(uv run git-cliff --bumped-version | sed 's/^v//')
          tag="v${next_version}"

          if git rev-parse "${tag}" >/dev/null 2>&1; then
            should_release=false
          else
            should_release=true
            # Update pyproject.toml version
            sed -i "s/^version = \".*\"/version = \"${next_version}\"/" pyproject.toml
          fi

          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "should_release=${should_release}" >> "${GITHUB_OUTPUT}"

      - name: generate changelog
        if: steps.version.outputs.should_release == 'true'
        uses: orhun/git-cliff-action@v4
        with:
          config: pyproject.toml
          args: --tag ${{ steps.version.outputs.tag }}
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: commit changes
        if: steps.version.outputs.should_release == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md pyproject.toml
          if git diff --cached --quiet; then
            exit 0
          fi
          git commit -m "chore(release): prepare for ${{ steps.version.outputs.tag }}"
          git push origin HEAD:main

      - name: create and push tag
        if: steps.version.outputs.should_release == 'true'
        run: |
          git tag "${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: generate release notes
        if: steps.version.outputs.should_release == 'true'
        id: release_notes
        uses: orhun/git-cliff-action@v4
        with:
          config: pyproject.toml
          args: --tag ${{ steps.version.outputs.tag }} --strip header
        env:
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: create github release
        if: steps.version.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          body: ${{ steps.release_notes.outputs.content }}

      - name: no-op when tag exists
        if: steps.version.outputs.should_release != 'true'
        run: echo "Tag ${{ steps.version.outputs.tag }} already exists; skipping release."
